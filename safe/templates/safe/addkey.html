{% extends "safe/base.html" %}


{% block content %}
<body>
  <button id="generate" class="btn btn-primary">Generate Keys</button><div id="time-report"></div>
  <div id="alert" style="display:none;">message</div>
  <textarea id="privkey" rows="15" style="width:100%"></textarea>
  <textarea id="pubkey" rows="15" style="width:100%"></textarea>
</body>

<script type="text/javascript">

function get_key(key_property_name) { 
    var key_property_name_prefix = "safe_" + key_property_name;
    if ( key_property_name_prefix in window )
    {  return window[key_property_name_prefix]; }
    else 
    {   var key_value = "";
        var key_storage =  new Lawnchair({name:'rsakeys'},  function(){ 
           this.get(key_property_name, function(key_record) {
               if (key_record) { 
                 key_value = key_record['key_value'] || "";
                 console.log('existence is: ' + key_record['key_value']);
               }
             });
        });
        window[key_property_name_prefix] = key_value;
        return key_value;
    }
}

function set_key(key_property_name, key)
{   
     var key_property_name_prefix = "safe_" + key_property_name;
     var key_storage =  new Lawnchair({name:'rsakeys'},  function(){
         this.save({key:key_property_name, key_value:key});
     });
     window[key_property_name_prefix] = key;
}

function get_privkey() {  return get_key("privkey"); }
function set_privkey(key) {  return set_key("privkey", key); }
function get_pubkey() {  return get_key("pubkey"); }
function set_pubkey(key) {  return set_key("pubkey", key); }


$(function () {


    //Change the key size value for new keys
    $(".change-key-size").each(function (index, value) {
      var el = $(value);
      var keySize = el.attr('data-value');
      el.click(function (e) {
        var button = $('#key-size');
        button.attr('data-value', keySize);
        button.html(keySize + ' bit <span class="caret"></span>');
        e.preventDefault();
      });
    });

    // Execute when they click the button.
    $('#execute').click(function () {

      // Create the encryption object.
      var crypt = new JSEncrypt();

      // Set the private.
      crypt.setPrivateKey($('#privkey').val());
      //return;
      // If no public key is set then set it here...
      var pubkey = $('#pubkey').val();
      if (!pubkey) {
        $('#pubkey').val(crypt.getPublicKey());
      }

      // Get the input and crypted values.
      var input = $('#input').val();
      var crypted = $('#crypted').val();

      // Alternate the values.
      if (input) {
        $('#crypted').val(crypt.encrypt(input));
        $('#input').val('');
      }
      else if (crypted) {
        var decrypted = crypt.decrypt(crypted);
        if (!decrypted)
          decrypted = 'This is a test!';
        $('#input').val(decrypted);
        $('#crypted').val('');
      }
    });

   // var privatekey_storage =  new Lawnchair({name:'rsakeys'},  function(){ 
        
    // If they wish to generate new keys.
    $('#generate').click(function () {
        
      var sKeySize = "2048";
      var sKeySize = "1024";
      var keySize = parseInt(sKeySize);
      crypt = new JSEncrypt({default_key_size: keySize});
      var async = true;
      var dt = new Date();
      var time = -(dt.getTime());
      if (async) {
        $('#time-report').text('.');
        var load = setInterval(function () {
          var text = $('#time-report').text();
          $('#time-report').text(text + '.');
        }, 500);
        crypt.getKey(function () {
          clearInterval(load);
          dt = new Date();
          time += (dt.getTime());
          $('#time-report').text('Generated in ' + time + ' ms');
	      var pubkey = crypt.getPublicKey();
	      var privkey = crypt.getPrivateKey();

	      var data = { pubkey: pubkey, };
	      $.ajax({
	       type: "POST",
	       url: '{{ url_key_add }}',
	       data: data,
	       dataType: "json",
           success: function(data, textStatus, jqXHR)
           {
              //data - response from server
              $("#alert").show( "fast", function() {
                  if(data.message) {
                         set_privkey(privkey);
                         set_pubkey(pubkey);
                         $('#privkey').val(privkey);
                         $('#pubkey').val(pubkey);
                        $( this ).html("Key Saved");
                   } else if( data.errors ) {
                        $( this ).html("Error with save " + data.errors);
                   } else {
                        $( this ).html("Unexpected Error");
                   }                    
              }).delay(2000).fadeOut( "5000");  ;
              
           },
           error: function (jqXHR, textStatus, errorThrown)
           {
              //data - response from server
              $("#alert").show( "fast", function() {
                  $( this ).html("Error with save " + data.errors).delay(2000).fadeOut( "5000");                     
              });
           }
           
	      });
      
        });
        return;
      }
      
    });
    
    //});
    
    
});
</script>
{% endblock %}